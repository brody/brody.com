---
import { Image } from 'astro:assets'
import { Icon } from 'astro-icon/components'
import Source from './Source.astro'

const {
  url,
  title,
  sourceTitle,
  pubDate,
  imageAlt,
  imageUrl,
  source,
  sourceUrl,
  description,
  content,
  loading = 'lazy',
} = Astro.props

// Function to format date as relative time or formatted date
function formatDate(pubDate: Date | string): string {
  // Convert string to Date if needed
  const dateObj = typeof pubDate === 'string' ? new Date(pubDate) : pubDate

  // Get current time
  const now = new Date()

  // Calculate time difference in milliseconds
  const diffTime = now.getTime() - dateObj.getTime()
  const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24))
  const diffHours = Math.floor(diffTime / (1000 * 60 * 60))
  const diffMinutes = Math.floor(diffTime / (1000 * 60))

  // If the date is in the future, just show the formatted date
  if (diffTime < 0) {
    const months = [
      'Jan',
      'Feb',
      'Mar',
      'Apr',
      'May',
      'Jun',
      'Jul',
      'Aug',
      'Sep',
      'Oct',
      'Nov',
      'Dec',
    ]
    const month = months[dateObj.getMonth()]
    const day = dateObj.getDate()
    const year = dateObj.getFullYear()

    // Include year if not current year
    if (year !== now.getFullYear()) {
      return `${month} ${day}, ${year}`
    }
    return `${month} ${day}`
  }

  // If less than an hour, show minutes
  if (diffMinutes < 60 && diffMinutes > 0) {
    return `${diffMinutes}m ago`
  }

  // If less than a day, show hours
  if (diffHours < 24 && diffHours > 0) {
    return `${diffHours}h ago`
  }

  // If within the past week, show relative time
  if (diffDays <= 7 && diffDays > 0) {
    if (diffDays === 1) return '1d ago'
    if (diffDays === 2) return '2d ago'
    if (diffDays === 3) return '3d ago'
    if (diffDays === 4) return '4d ago'
    if (diffDays === 5) return '5d ago'
    if (diffDays === 6) return '6d ago'
    if (diffDays === 7) return '7d ago'
  }

  // For older dates, format as "Sep 16" or "Sep 16, 2024" if not current year
  const months = [
    'Jan',
    'Feb',
    'Mar',
    'Apr',
    'May',
    'Jun',
    'Jul',
    'Aug',
    'Sep',
    'Oct',
    'Nov',
    'Dec',
  ]
  const month = months[dateObj.getMonth()]
  const day = dateObj.getDate()
  const year = dateObj.getFullYear()

  // Include year if not current year
  if (year !== now.getFullYear()) {
    return `${month} ${day}, ${year}`
  }
  return `${month} ${day}`
}
---

<li class='py-8 dashed-border'>
  <a href={url} class='block mb-3 text-sm text-tx-3'>
    <!-- {source === 'journal' ? 'Posted' : 'Read'} -->
    Posted {formatDate(pubDate)}
  </a>
  <div class='flex flex-row gap-6'>
    <div class='w-full'>
      {
        title && (
          <a href={url}>
            <h2 class='text-h1 font-heading hover:text-tx-1 text-tx-0'>{title}</h2>
          </a>
        )
      }

      {/* Show markdown content between title and source */}
      {
        content && (
          <div class='mt-3 mb-4 max-w-none content-preview prose prose-base'>
            <content.Content />
          </div>
        )
      }

      {/* Show source information for bookmarks */}
      {
        (sourceUrl || imageUrl) && (
          <Source
            sourceTitle={sourceTitle || title}
            url={sourceUrl || '#'}
            imageUrl={imageUrl}
            description={description}
            loading={loading}
          />
        )
      }
    </div>
  </div>
</li>

<style>
  .dashed-border {
    position: relative;
  }

  .dashed-border::after {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    height: 1px;
    background: linear-gradient(
      90deg,
      transparent 4px,
      var(--color-ui-1) 4px,
      var(--color-ui-1) 8px
    );
    background-size: 8px 1px;
  }

  .content-preview {
    position: relative;
    max-height: 20rem; /* Roughly 200 words, approximately 8-10 lines */
    overflow: hidden;
  }

  .content-preview::after {
    content: '';
    display: block;
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 150px;
    background: linear-gradient(to bottom, transparent 0%, var(--color-bg-1) 100%);
    pointer-events: none;
    z-index: 1;
  }
</style>
